<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TikTop Hooks - Em Alta | V√≠deos Virais do TikTok</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
  <style>
    /* Erros / mensagens */
    #loginError, #recoveryError {
      color: #fe2c55;
      font-size: 14px;
      font-weight: 500;
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(254,44,85,0.1);
      border: 1px solid rgba(254,44,85,0.3);
      display: none;
    }
    #loginError.show, #recoveryError.show {
      display: block;
    }
    #recoveryMessage {
      color: #25f4ee;
      font-size: 14px;
      font-weight: 500;
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(37,244,238,0.1);
      border: 1px solid rgba(37,244,238,0.3);
      display: none;
    }
    #recoveryMessage.show {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Pop-up de Login -->
  <div class="popup" id="loginPopup">
    <div class="popup-content">
      <h3>TikTop Hooks</h3>
      <p class="popup-subtitle">O radar dos v√≠deos que todo mundo quer ver!</p>
      <input type="email" id="email" placeholder="Seu melhor e-mail" required />
      <input type="password" id="password" placeholder="Sua senha secreta" required />
      <button id="loginButton">Entrar Agora</button>
      <div class="forgot-password-link">
        <span id="forgotPasswordBtn">Esqueci minha senha</span>
      </div>
      <div class="divider">
        <span>N√£o tem conta?</span>
      </div>
      <a href="https://lastlink.com/p/C77832B06/checkout-payment/" target="_blank" id="registerButton" class="register-button">
        Cadastre-se Gr√°tis
      </a>
      <div id="loginError"></div>
    </div>
  </div>

  <!-- Pop-up de Recupera√ß√£o de Senha -->
  <div class="recovery-popup" id="recoveryPopup" style="display: none;">
    <div class="recovery-content">
      <button class="close-btn" id="closeRecoveryBtn">√ó</button>
      <h3>Recuperar Senha</h3>
      <p class="recovery-subtitle">Digite seu e-mail e enviaremos um link para redefinir sua senha em poucos segundos</p>
      <input type="email" id="recoveryEmail" placeholder="Seu e-mail cadastrado" required />
      <button id="sendRecoveryBtn">Enviar Link de Recupera√ß√£o</button>
      <div class="back-to-login-link">
        <span id="backToLoginBtn">Voltar ao Login</span>
      </div>
      <div id="recoveryMessage"></div>
      <div id="recoveryError"></div>
    </div>
  </div>

  <header class="header">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon">
          <img src="https://icones.pro/wp-content/uploads/2021/03/logo-icone-tiktok.png" alt="TikTok">
        </div>
        <div class="logo-text">
          <div class="logo-main">TikTop Hooks</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="../" class="logout-btn">Voltar</a>
      </div>
    </div>
    
    <!-- Nova √°rea de filtros seguindo o padr√£o do template -->
    <div class="header-filters">
      <div class="filters-container">
        <div class="filters-form">
          <div class="filter-group">
            <label class="filter-label">Palavra-chave (opcional)</label>
            <div class="search-input-container">
              <input type="text" id="keyword" class="filter-input" placeholder="O que voc√™ quer descobrir?">
              <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Regi√£o</label>
            <select id="region" class="filter-select">
              <option value="" selected>Todas as regi√µes</option>
              <option value="ar">Argentina</option>
              <option value="au">Austr√°lia</option>
              <option value="bd">Bangladesh</option>
              <option value="be">B√©lgica</option>
              <option value="bo">Bol√≠via</option>
              <option value="br">Brasil</option>
              <option value="ca">Canad√°</option>
              <option value="cl">Chile</option>
              <option value="cn">China</option>
              <option value="co">Col√¥mbia</option>
              <option value="cr">Costa Rica</option>
              <option value="dk">Dinamarca</option>
              <option value="ec">Equador</option>
              <option value="eg">Egito</option>
              <option value="es">Espanha</option>
              <option value="us">Estados Unidos</option>
              <option value="ph">Filipinas</option>
              <option value="fi">Finl√¢ndia</option>
              <option value="fr">Fran√ßa</option>
              <option value="de">Alemanha</option>
              <option value="gh">Gana</option>
              <option value="gt">Guatemala</option>
              <option value="hn">Honduras</option>
              <option value="id">Indon√©sia</option>
              <option value="in">√çndia</option>
              <option value="it">It√°lia</option>
              <option value="jp">Jap√£o</option>
              <option value="ke">Qu√™nia</option>
              <option value="kr">Coreia do Sul</option>
              <option value="mx">M√©xico</option>
              <option value="my">Mal√°sia</option>
              <option value="ng">Nig√©ria</option>
              <option value="nl">Holanda</option>
              <option value="pa">Panam√°</option>
              <option value="pe">Peru</option>
              <option value="pk">Paquist√£o</option>
              <option value="pl">Pol√¥nia</option>
              <option value="pt">Portugal</option>
              <option value="py">Paraguai</option>
              <option value="uk">Reino Unido</option>
              <option value="do">Rep√∫blica Dominicana</option>
              <option value="ro">Rom√™nia</option>
              <option value="se">Su√©cia</option>
              <option value="sg">Singapura</option>
              <option value="th">Tail√¢ndia</option>
              <option value="tr">Turquia</option>
              <option value="ve">Venezuela</option>
              <option value="za">√Åfrica do Sul</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Per√≠odo</label>
            <select id="period" class="filter-select">
              <option value="" selected>Todos os per√≠odos</option>
              <option value="today">Hoje</option>
              <option value="week">Esta semana</option>
              <option value="month">Este m√™s</option>
              <option value="3months">√öltimos 3 meses</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Ordenar</label>
            <select id="sortBy" class="filter-select">
              <option value="play_count" selected>Mais visualiza√ß√µes</option>
              <option value="digg_count">Mais curtidas</option>
              <option value="comment_count">Mais coment√°rios</option>
              <option value="share_count">Mais compartilhamentos</option>
              <option value="create_time">Mais recentes</option>
              <option value="title">Ordem alfab√©tica</option>
            </select>
          </div>
          <button type="button" id="searchBtn" class="discover-btn">FILTRAR</button>
          <button type="button" id="clearAllBtn" class="restore-btn" style="display: none;">RESTAURAR</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Barra decorativa -->
  <div class="decorative-bar"></div>

  <main class="main-content">
    <div class="videos-grid" id="videosGrid"></div>
    <div class="loading" id="loading" style="display: none;">
      <div class="spinner"></div>
      <div class="loading-text">Carregando v√≠deos em alta...</div>
    </div>
    <div class="tiktok-logos-container" id="tikTokLogos">
      <!-- Aqui v√£o suas logos animadas -->
    </div>
  </main>

  <!-- Bot√£o Voltar ao Topo -->
  <button id="backToTop" class="back-to-top" title="Voltar ao topo">
    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
      <path d="M7 14l5-5 5 5z"/>
    </svg>
  </button>

  <script src="script.js"></script>
  <script>
    // Script espec√≠fico para p√°gina Em Alta com sistema de filtros avan√ßado
    
    const VIDEOS_WEBHOOK_URL = 'https://n8n-2025n8n.wjemh8.easypanel.host/webhook/401a80db-15a7-4886-833a-df240d641c7a';
    const LOGIN_WEBHOOK_URL = 'https://n8n-2025n8n.wjemh8.easypanel.host/webhook/0bbfaeaa-d9cb-4a4d-960c-cfedf598e547';
    const RECOVERY_WEBHOOK_URL = 'https://n8n-2025n8n.wjemh8.easypanel.host/webhook/password-recovery';
    
    let videosData = [];
    let filteredVideosData = [];
    let filtersActive = false;
    let autoRefreshInterval = null;
    let userId = null;
    let defaultFilters = {
      keyword: '',
      region: '',
      period: '',
      sortBy: 'play_count'
    };

    // Cookies
    function setCookie(name, value, days) {
      const expires = new Date();
      expires.setTime(expires.getTime() + days*24*60*60*1000);
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }
    function getCookie(name) {
      const nameEQ = name + '=';
      const ca = document.cookie.split(';');
      for (let c of ca) {
        c = c.trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
      }
      return null;
    }
    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`;
    }

    // Fun√ß√£o para formatar n√∫meros
    function formatNumber(num) {
      if (num >= 1e6) return (num/1e6).toFixed(1) + 'M';
      if (num >= 1e3) return (num/1e3).toFixed(1) + 'K';
      return num?.toString() || '0';
    }
    
    // Fun√ß√£o para obter iniciais
    function getInitials(name) {
      return name ? name.charAt(0).toUpperCase() : '?';
    }

    // Verifica login salvo
    function checkExistingLogin() {
      const savedUserId = getCookie('tiktok_user_id');
      const savedEmail = getCookie('tiktok_user_email');
      if (savedUserId && savedEmail) {
        userId = savedUserId;
        document.getElementById('loginPopup').style.display = 'none';
        return true;
      }
      return false;
    }

    // Fun√ß√£o para extrair dados dos v√≠deos (com m√∫ltiplas tentativas de estruturas)
    function extractVideoData(rawData) {
      let videos = [];
      
      // Tentativa 1: Array direto
      if (Array.isArray(rawData)) {
        videos = rawData;
      }
      // Tentativa 2: Objeto com propriedade 'videos'
      else if (rawData && rawData.videos && Array.isArray(rawData.videos)) {
        videos = rawData.videos;
      }
      // Tentativa 3: Objeto com 'data.videos'
      else if (rawData && rawData.data && Array.isArray(rawData.data.videos)) {
        videos = rawData.data.videos;
      }
      // Tentativa 4: Dados do Supabase (array de registros)
      else if (rawData && Array.isArray(rawData)) {
        videos = rawData;
      }
      // Tentativa 5: V√≠deo √∫nico
      else if (rawData && (rawData.aweme_id || rawData.video_id || rawData.title)) {
        videos = [rawData];
      }
      
      // Processar e normalizar os v√≠deos
      const processedVideos = videos.map((video, index) => {
        if (!video) return null;
        
        // Tentar extrair dados do autor
        let authorData = {};
        if (video.author) {
          authorData = video.author;
        } else if (video.author_nickname || video.author_id) {
          authorData = {
            id: video.author_id,
            unique_id: video.author_unique_id,
            nickname: video.author_nickname,
            avatar: video.author_avatar
          };
        }
        
        // Tentar extrair informa√ß√µes de m√∫sica
        let musicData = {};
        if (video.music_info) {
          musicData = video.music_info;
        } else if (video.music_id || video.music_title) {
          musicData = {
            id: video.music_id,
            title: video.music_title,
            author: video.music_author
          };
        }
        
        const processed = {
          aweme_id: video.aweme_id || video.video_id || video.id || null,
          video_id: video.video_id || video.aweme_id || video.id || null,
          title: video.title || video.desc || 'Sem t√≠tulo',
          duration: video.duration || 0,
          play: video.play || video.video_url || video.url || null,
          wmplay: video.wmplay || video.play || null,
          cover: video.cover || video.thumbnail || video.cover_url || null,
          author: {
            id: authorData.id || null,
            unique_id: authorData.unique_id || authorData.uniqueId || null,
            nickname: authorData.nickname || authorData.nickName || 'Autor desconhecido',
            avatar: authorData.avatar || authorData.avatarUrl || null
          },
          play_count: parseInt(video.play_count || video.playCount || 0),
          digg_count: parseInt(video.digg_count || video.diggCount || video.like_count || video.likeCount || 0),
          comment_count: parseInt(video.comment_count || video.commentCount || 0),
          share_count: parseInt(video.share_count || video.shareCount || 0),
          download_count: parseInt(video.download_count || video.downloadCount || 0),
          music_info: musicData,
          create_time: video.create_time || video.createTime || video.created_at || null,
          region: video.region || video.country || video.location || null // Tentar diferentes campos
        };
        
        return processed;
      }).filter(video => video !== null);
      
      return processedVideos;
    }

    // Fun√ß√£o para detectar e normalizar regi√£o
    function detectAndNormalizeRegion(regionData) {
      if (!regionData) return null;
      
      const region = String(regionData).toLowerCase().trim();
      
      // Mapear diferentes formatos para c√≥digos de 2 letras
      const regionMap = {
        'br': 'br', 'us': 'us', 'uk': 'uk', 'gb': 'uk', 'de': 'de', 'fr': 'fr',
        'es': 'es', 'it': 'it', 'jp': 'jp', 'kr': 'kr', 'cn': 'cn', 'in': 'in',
        'mx': 'mx', 'id': 'id', 'ph': 'ph', 'bd': 'bd', 'eg': 'eg', 'ng': 'ng',
        'pk': 'pk', 'ca': 'ca', 'au': 'au', 'pl': 'pl', 'nl': 'nl', 'se': 'se',
        'dk': 'dk', 'be': 'be', 'tr': 'tr', 'my': 'my', 'th': 'th', 'sg': 'sg',
        'za': 'za', 'ar': 'ar', 'cl': 'cl', 'co': 'co', 'pe': 'pe', 've': 've',
        'ec': 'ec', 'py': 'py', 'bo': 'bo', 'cr': 'cr', 'gt': 'gt', 'hn': 'hn',
        'do': 'do', 'pa': 'pa', 'ni': 'ni', 'ro': 'ro', 'ua': 'ua', 'md': 'md',
        'ma': 'ma', 'gh': 'gh', 'ke': 'ke', 'tz': 'tz', 'et': 'et', 'sn': 'sn',
        'fi': 'fi', 'pt': 'pt', 'lb': 'lb', 'mm': 'mm', 'bh': 'bh', 'kz': 'kz',
        'mf': 'mf', 'xk': 'xk', 'iq': 'iq', 'np': 'np',
        
        // Nomes completos para c√≥digos
        'brasil': 'br', 'brazil': 'br',
        'estados unidos': 'us', 'united states': 'us', 'usa': 'us',
        'reino unido': 'uk', 'united kingdom': 'uk', 'england': 'uk',
        'alemanha': 'de', 'germany': 'de',
        'fran√ßa': 'fr', 'france': 'fr',
        'espanha': 'es', 'spain': 'es',
        'it√°lia': 'it', 'italy': 'it',
        'jap√£o': 'jp', 'japan': 'jp',
        'm√©xico': 'mx', 'mexico': 'mx',
        'canad√°': 'ca', 'canada': 'ca',
        'austr√°lia': 'au', 'australia': 'au'
      };
      
      return regionMap[region] || null;
    }

    // Fun√ß√£o de busca avan√ßada
    function searchInVideo(video, keyword) {
      if (!keyword) return true;
      
      const searchText = keyword.toLowerCase();
      
      // Buscar no t√≠tulo
      if (video.title && video.title.toLowerCase().includes(searchText)) {
        return true;
      }
      
      // Buscar no nome do autor
      if (video.author && video.author.nickname && video.author.nickname.toLowerCase().includes(searchText)) {
        return true;
      }
      
      // Buscar no unique_id do autor
      if (video.author && video.author.unique_id && video.author.unique_id.toLowerCase().includes(searchText)) {
        return true;
      }
      
      // Buscar nas informa√ß√µes de m√∫sica
      if (video.music_info) {
        if (video.music_info.title && video.music_info.title.toLowerCase().includes(searchText)) {
          return true;
        }
        if (video.music_info.author && video.music_info.author.toLowerCase().includes(searchText)) {
          return true;
        }
      }
      
      return false;
    }

    // Fun√ß√£o de filtro por per√≠odo
    function filterByPeriod(videos, period) {
      if (!period) return videos;
      
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      return videos.filter(video => {
        if (!video.create_time) return true;
        
        const videoDate = new Date(video.create_time * 1000);
        
        switch (period) {
          case 'today':
            return videoDate >= today;
          case 'week':
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            return videoDate >= weekAgo;
          case 'month':
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            return videoDate >= monthAgo;
          case '3months':
            const threeMonthsAgo = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
            return videoDate >= threeMonthsAgo;
          default:
            return true;
        }
      });
    }

    // Fun√ß√£o para aplicar filtros
    function applyFilters() {
      const keyword = document.getElementById('keyword').value.trim();
      const region = document.getElementById('region').value;
      const period = document.getElementById('period').value;
      const sortBy = document.getElementById('sortBy').value;

      let filtered = [...videosData];

      // Verificar se algum filtro est√° ativo
      filtersActive = keyword !== defaultFilters.keyword || 
                      region !== defaultFilters.region || 
                      period !== defaultFilters.period;

      // Filtro por palavra-chave
      if (keyword) {
        filtered = filtered.filter(video => searchInVideo(video, keyword));
      }

      // Filtro por regi√£o
      if (region) {
        filtered = filtered.filter(video => {
          if (!video.region) return false;
          
          const normalizedVideoRegion = detectAndNormalizeRegion(video.region);
          return normalizedVideoRegion === region;
        });
      }

      // Filtro por per√≠odo
      filtered = filterByPeriod(filtered, period);

      // Ordena√ß√£o
      filtered.sort((a, b) => {
        switch (sortBy) {
          case 'play_count':
            return (b.play_count || 0) - (a.play_count || 0);
          case 'digg_count':
            return (b.digg_count || 0) - (a.digg_count || 0);
          case 'comment_count':
            return (b.comment_count || 0) - (a.comment_count || 0);
          case 'share_count':
            return (b.share_count || 0) - (a.share_count || 0);
          case 'create_time':
            return (b.create_time || 0) - (a.create_time || 0);
          case 'title':
            return (a.title || '').localeCompare(b.title || '');
          default:
            return 0;
        }
      });

      filteredVideosData = filtered;
      renderVideos();
      updateRestoreButtonVisibility();
    }

    // Restaurar filtros padr√£o
    function resetToDefaultFilters() {
      document.getElementById('keyword').value = defaultFilters.keyword;
      document.getElementById('region').value = defaultFilters.region;
      document.getElementById('period').value = defaultFilters.period;
      document.getElementById('sortBy').value = defaultFilters.sortBy;
      
      filtersActive = false;
      applyFilters();
    }

    // Atualizar visibilidade do bot√£o restaurar
    function updateRestoreButtonVisibility() {
      const restoreBtn = document.getElementById('clearAllBtn');
      
      if (filtersActive) {
        restoreBtn.style.display = 'block';
        restoreBtn.disabled = false;
      } else {
        restoreBtn.style.display = 'none';
      }
    }

    // Fun√ß√£o para adicionar badges "Em Alta" aos v√≠deos
    function addEmAltaBadges() {
      const videoCards = document.querySelectorAll('.video-card');
      videoCards.forEach((card, index) => {
        if (!card.querySelector('.em-alta-badge')) {
          const badge = document.createElement('div');
          badge.className = 'em-alta-badge';
          badge.innerHTML = 'üî• EM ALTA';
          
          const videoWrapper = card.querySelector('.video-wrapper');
          if (videoWrapper) {
            videoWrapper.style.position = 'relative';
            videoWrapper.appendChild(badge);
          }
        }
      });
    }

    // Carrega v√≠deos
    async function loadVideos() {
      const loading = document.getElementById('loading');
      const grid = document.getElementById('videosGrid');

      loading.style.display = 'flex';
      grid.innerHTML = '';

      // Garantir que userId existe - n√£o requer login
      if (!userId) {
        const savedUserId = getCookie('tiktok_user_id');
        if (savedUserId) {
          userId = savedUserId;
        } else {
          userId = 'emalta_' + Math.random().toString(36).substr(2, 9);
        }
      }

      try {
        // Pegar valores dos filtros para enviar na requisi√ß√£o
        const keyword = document.getElementById('keyword').value || '';
        const region = document.getElementById('region').value || '';
        const period = document.getElementById('period').value || '';
        const sortBy = document.getElementById('sortBy').value || 'play_count';
        
        const requestBody = { 
          userId: userId,
          keyword: keyword,
          region: region,
          period: period,
          sortBy: sortBy,
          emalta: true
        };
        
        const res = await fetch(VIDEOS_WEBHOOK_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(requestBody)
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const rawData = await res.json();
        
        // Extrair e processar v√≠deos usando a fun√ß√£o existente
        const processedVideos = extractVideoData(rawData);
        
        if (processedVideos && processedVideos.length > 0) {
          videosData = processedVideos;
          applyFilters(); // Aplicar filtros ap√≥s carregar
          addEmAltaBadges();
        } else {
          grid.innerHTML = `
            <div class="error-state">
              <span class="emoji">‚è∞</span>
              <h3>Nenhum v√≠deo dispon√≠vel</h3>
              <p>Nenhum v√≠deo foi encontrado no momento. Tente ajustar os filtros ou aguarde alguns minutos.</p>
            </div>`;
        }
      } catch (err) {
        console.error('Erro ao carregar v√≠deos:', err);
        grid.innerHTML = `
          <div class="error-state">
            <span class="emoji">‚ùå</span>
            <h3>Erro ao carregar</h3>
            <p>Erro ao carregar os dados: ${err.message}. Tente novamente em alguns minutos.</p>
          </div>`;
      } finally {
        loading.style.display = 'none';
      }
    }

    // Cria o card de v√≠deo
    function createVideoCard(video, index) {
      const card = document.createElement('div');
      card.className = 'video-card';
      
      // Usar nickname do autor corretamente
      const authorNickname = video.author?.nickname || 'usuario';
      
      card.innerHTML = `
        <div class="video-wrapper">
          ${video.play ? `
            <video class="video-player" controls preload="metadata">
              <source src="${video.play}" type="video/mp4">
              Seu navegador n√£o suporta v√≠deo.
            </video>
          ` : `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--tiktok-gray);">
              V√≠deo n√£o dispon√≠vel
            </div>
          `}
        </div>
        <div class="video-info">
          <div class="video-title">${video.title || 'Sem t√≠tulo'}</div>
          <div class="video-author">
            <div class="author-avatar">${getInitials(authorNickname)}</div>
            <span class="author-name">@${authorNickname}</span>
          </div>
          <div class="video-stats">
            <div class="stats-left">
              <div class="stat-item">
                <svg class="stat-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                ${formatNumber(video.play_count)}
              </div>
              <div class="stat-item">
                <svg class="stat-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                ${formatNumber(video.digg_count)}
              </div>
              <div class="stat-item">
                <svg class="stat-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                ${formatNumber(video.comment_count)}
              </div>
              <div class="stat-item">
                <svg class="stat-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                </svg>
                ${formatNumber(video.share_count)}
              </div>
            </div>
          </div>
        </div>
      `;
      return card;
    }

    // Renderiza os v√≠deos na grid
    function renderVideos() {
      const grid = document.getElementById('videosGrid');
      grid.innerHTML = '';
      
      if (filteredVideosData.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <span class="emoji">üîç</span>
            <h3>Nenhum v√≠deo encontrado</h3>
            <p>Nenhum v√≠deo corresponde aos filtros aplicados. Tente ajustar os crit√©rios de busca.</p>
          </div>`;
        return;
      }

      filteredVideosData.forEach((video, index) => {
        try {
          const cardElement = createVideoCard(video, index);
          grid.appendChild(cardElement);
        } catch (err) {
          console.error(`Erro ao criar card do v√≠deo ${index}:`, err);
        }
      });
      
      // Adicionar badges ap√≥s renderizar
      setTimeout(() => addEmAltaBadges(), 100);
    }

    // Eventos de login
    document.getElementById('loginButton').addEventListener('click', async () => {
      const loginBtn = document.getElementById('loginButton');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const loginError = document.getElementById('loginError');
      loginError.classList.remove('show');
      loginError.textContent = '';

      if (!email || !password) {
        loginError.textContent = 'Por favor, preencha todos os campos';
        return loginError.classList.add('show');
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Entrando...';

      try {
        const res = await fetch(LOGIN_WEBHOOK_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        const result = await res.json();

        if (result.success) {
          userId = result.userId;
          setCookie('tiktok_user_id', userId, 7);
          setCookie('tiktok_user_email', email, 7);
          document.getElementById('loginPopup').style.display = 'none';
          loadVideos();
          startAutoRefresh();
        } else {
          loginError.textContent = result.message || 'Login inv√°lido.';
          loginError.classList.add('show');
        }
      } catch (err) {
        loginError.textContent = 'Erro ao conectar. Verifique sua internet.';
        loginError.classList.add('show');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Entrar Agora';
      }
    });

    // Esqueci senha
    document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
      document.getElementById('recoveryPopup').style.display = 'flex';
      document.getElementById('recoveryEmail').focus();
    });

    // Voltar ao login / fechar recovery
    document.getElementById('backToLoginBtn').addEventListener('click', () => {
      document.getElementById('recoveryPopup').style.display = 'none';
      clearRecoveryForm();
      document.getElementById('email').focus();
    });
    document.getElementById('closeRecoveryBtn').addEventListener('click', () => {
      document.getElementById('recoveryPopup').style.display = 'none';
      clearRecoveryForm();
    });

    // Envia link de recupera√ß√£o
    document.getElementById('sendRecoveryBtn').addEventListener('click', async () => {
      const btn = document.getElementById('sendRecoveryBtn');
      const email = document.getElementById('recoveryEmail').value;
      const msg = document.getElementById('recoveryMessage');
      const err = document.getElementById('recoveryError');
      msg.classList.remove('show');
      err.classList.remove('show');
      msg.textContent = err.textContent = '';

      if (!email) {
        err.textContent = 'Por favor, digite seu e-mail';
        return err.classList.add('show');
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        err.textContent = 'Digite um e-mail v√°lido';
        return err.classList.add('show');
      }

      btn.disabled = true;
      btn.textContent = 'Enviando...';

      try {
        const res = await fetch(RECOVERY_WEBHOOK_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email })
        });
        const result = await res.json();

        if (result.success) {
          msg.textContent = 'Link enviado! Verifique seu e-mail.';
          msg.classList.add('show');
          setTimeout(() => {
            document.getElementById('recoveryPopup').style.display = 'none';
            clearRecoveryForm();
          }, 3000);
        } else {
          err.textContent = result.message || 'Erro interno.';
          err.classList.add('show');
        }
      } catch (e) {
        err.textContent = 'Erro ao conectar.';
        err.classList.add('show');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enviar Link de Recupera√ß√£o';
      }
    });

    function clearRecoveryForm() {
      document.getElementById('recoveryEmail').value = '';
      document.getElementById('recoveryMessage').classList.remove('show');
      document.getElementById('recoveryError').classList.remove('show');
    }

    document.getElementById('recoveryPopup').addEventListener('click', e => {
      if (e.target === document.getElementById('recoveryPopup')) {
        document.getElementById('recoveryPopup').style.display = 'none';
        clearRecoveryForm();
      }
    });

    // Permite Enter nos formul√°rios
    ['email','password','recoveryEmail'].forEach(id => {
      document.getElementById(id).addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          if (id === 'email') document.getElementById('password').focus();
          else if (id === 'password') document.getElementById('loginButton').click();
          else document.getElementById('sendRecoveryBtn').click();
        }
      });
    });

    // Eventos dos filtros
    document.getElementById('searchBtn').addEventListener('click', () => {
      applyFilters();
    });

    // Auto-aplica√ß√£o de filtros
    document.getElementById('keyword').addEventListener('input', () => {
      setTimeout(applyFilters, 300); // Debounce
    });
    document.getElementById('region').addEventListener('change', applyFilters);
    document.getElementById('period').addEventListener('change', applyFilters);
    document.getElementById('sortBy').addEventListener('change', applyFilters);

    // Limpar todos os filtros - volta ao padr√£o
    document.getElementById('clearAllBtn').addEventListener('click', () => {
      resetToDefaultFilters();
    });

    // Auto-refresh a cada 5 minutos (apenas quando explicitamente ativado)
    function startAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      
      autoRefreshInterval = setInterval(() => {
        loadVideos();
      }, 5 * 60 * 1000);
    }

    // Inicializa√ß√£o
    window.addEventListener('load', () => {
      // Configurar filtros padr√£o
      resetToDefaultFilters();
      
      if (checkExistingLogin()) {
        loadVideos();
        startAutoRefresh();
      } else {
        document.getElementById('email').focus();
      }
    });

    // Limpa interval ao sair da p√°gina
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
</body>
</html>
